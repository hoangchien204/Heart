import { Page } from "react-pdf";
import type { PDFPageProxy } from "pdfjs-dist";

interface PdfPageWrapperProps {
  pageNumber: number;
  pageWidth: number;
  highlightMode: boolean;
  onTextSelect?: () => void;
}

export default function PdfPageWrapper({
  pageNumber,
  pageWidth,
  highlightMode,
  onTextSelect,
}: PdfPageWrapperProps) {
  const syncTextLayer = (pdfPage: PDFPageProxy, highlightMode: boolean) => {
    const pageNumber = pdfPage.pageNumber;

    const textLayer = document.querySelector(
      `#page-${pageNumber} .react-pdf__Page__textContent`
    ) as HTMLElement;

    const svg = document.querySelector(
      `#page-${pageNumber} svg`
    ) as SVGElement;

    if (textLayer && svg) {
      const { width, height } = svg.getBoundingClientRect();

      textLayer.style.width = `${width}px`;
      textLayer.style.height = `${height}px`;
      textLayer.style.position = "absolute";
      textLayer.style.top = "0";
      textLayer.style.left = "0";
      textLayer.style.transformOrigin = "0 0";
      textLayer.style.transform = svg.style.transform; // ✅ chỉ set 1 lần

      // xử lý từng span
      textLayer.querySelectorAll("span").forEach((el) => {
        const span = el as HTMLElement;
        if (highlightMode) {
          span.style.color = "transparent"; // ẩn text gốc
          span.style.background = "transparent";
          span.style.userSelect = "text";
          span.style.pointerEvents = "auto";
        } else {
          span.style.color = ""; // reset về mặc định
          span.style.userSelect = "none";
          span.style.pointerEvents = "none";
        }
      });
    }
  };
  return (
    <div
      id={`page-${pageNumber}`}
      className={`pdf-page-wrapper ${highlightMode ? "highlight-mode" : ""}`}
      onMouseUp={onTextSelect}
    >
      <Page
        className="pdf-page-item border border-gray-300 rounded-md shadow-sm"
        pageNumber={pageNumber}
        width={Math.min(pageWidth, 600)}
        renderMode="svg"
        renderTextLayer
        renderAnnotationLayer={false}
        onRenderSuccess={(pdfPage) => syncTextLayer(pdfPage, highlightMode)}
      />
    </div>
  );
}
